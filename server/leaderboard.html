 <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BubbleClash — Leaderboard</title>
  <style>
    :root{--bg1:#071029;--bg2:#081226;--accent:#7c3aed}
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; margin:0; padding:24px; }
    .container { max-width:980px; margin:0 auto }
    h1 { font-size:22px; margin:0 0 12px 0 }
    .hero{position:relative;padding:14px;border-radius:14px;overflow:visible}
    .glow-bg{position:absolute;inset:-20%;background:radial-gradient(circle at 10% 20%, rgba(124,58,237,0.12), transparent 6%), radial-gradient(circle at 90% 80%, rgba(14,165,233,0.06), transparent 6%);filter:blur(48px);z-index:0;pointer-events:none}
    .card{position:relative;z-index:2;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)); border-radius:12px; overflow:hidden; box-shadow:0 12px 40px rgba(2,6,23,0.6)}
    .row{display:grid;grid-template-columns:48px 1fr 90px 90px 80px;gap:8px;padding:12px 16px;align-items:center}
    .row.header{font-weight:700;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
    .row + .row{border-top:1px solid rgba(255,255,255,0.02)}
    .player{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small{font-size:13px;color:rgba(255,255,255,0.7)}
    .controls{margin-bottom:12px;display:flex;gap:8px;align-items:center;z-index:2;position:relative}
    select,input{background:rgba(255,255,255,0.03);border:0;padding:10px;border-radius:8px;color:#fff}
    button{background:linear-gradient(90deg,var(--accent),#0ea5e9);border:0;padding:8px 12px;border-radius:10px;color:#fff;cursor:pointer}
    button.danger{background:#ef4444}
    .muted{color:rgba(255,255,255,0.6)}
    .tilt-area{perspective:1200px}
    .tilt-card{transition:transform 0.15s ease-out;transform-style:preserve-3d}
  </style>
</head>
<body>
  <div class="container">
    <h1>Leaderboard</h1>
    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center;">
        <label for="gameSelect" class="small" style="color:#cbd5e1">View:</label>
        <select id="gameSelect"></select>
        <select id="arenaSelect" style="margin-left:8px;padding:8px;border-radius:6px">
          <option value="normal">Normal</option>
          <option value="boss">Boss</option>
        </select>
        <input id="search" placeholder="Search player..." style="min-width:220px;padding:8px;border-radius:6px;border:0;background:rgba(255,255,255,0.03);color:#fff" />
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="refresh">Refresh</button>
        <button id="reset" class="danger">Reset All</button>
      </div>
    </div>

    <div id="winnerCard" style="margin-bottom:12px; display:none"></div>

    <div class="card" id="table">
      <div class="row header">
        <div style="width:48px">#</div>
        <div>Player</div>
        <div style="text-align:right">Kills</div>
        <div style="text-align:right">Hits</div>
        <div style="text-align:right">Wins</div>
      </div>
      <div id="rows"></div>
    </div>
    
  </div>

  <script>
    const rowsEl = document.getElementById('rows');
    const refreshBtn = document.getElementById('refresh');
    const resetBtn = document.getElementById('reset');
    const gameSelect = document.getElementById('gameSelect');
    const searchInput = document.getElementById('search');
    const winnerCard = document.getElementById('winnerCard');

    let gamesCache = [];
    let currentList = [];

    function showWinnerBox(player, meta) {
      if (!player) { winnerCard.style.display = 'none'; return; }
      winnerCard.style.display = 'block';
      const displayName = String(player || '').replace(/^https?:\/\/[^\/]+\//, '').replace(/^\/+/, '').split('/').pop();
      winnerCard.innerHTML = `<div class="card" style="padding:12px;display:flex;align-items:center;gap:12px"><div style="width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#374151,#111827);color:#fff;font-weight:700">${(displayName||'P').slice(0,2).toUpperCase()}</div><div style="flex:1"><div style="font-weight:700">${displayName}</div><div class="small muted">${meta||''}</div></div></div>`;
    }

    async function fetchGames() {
      try {
        const arena = (arenaSelect.value || 'normal');
        const res = await fetch('/api/stats/games?arena=' + encodeURIComponent(arena));
        const data = await res.json();
        gamesCache = data || [];
        // populate select, but preserve current selection if possible
        const prev = gameSelect.value || 'combined';
        gameSelect.innerHTML = '';
        const optA = document.createElement('option');
        optA.value = 'combined';
        optA.textContent = 'Combined (All Games)';
        gameSelect.appendChild(optA);
        for (let i = 0; i < gamesCache.length; i++) {
          const g = gamesCache[i];
          const o = document.createElement('option');
          o.value = g.id;
          const dt = g.createdAt ? new Date(g.createdAt).toLocaleString() : g.id;
          // show friendly names: Game 1, Game 2, ... (value remains the game id)
          const friendly = `Game ${i + 1}`;
          o.textContent = `${friendly} — ${dt}` + (g.winner ? ` — Winner: ${String(g.winner).split('/').pop()}` : '');
          gameSelect.appendChild(o);
        }
        // try to restore previous selection
        try {
          if (prev && Array.from(gameSelect.options).some(o => o.value === prev)) {
            gameSelect.value = prev;
          } else {
            gameSelect.value = 'combined';
          }
        } catch (e) {}
      } catch (e) {
        console.error('failed to load games', e);
      }
    }

    async function fetchStatsFor(selection) {
      try {
        const arena = (arenaSelect.value || 'normal');
        let url = '/api/stats?arena=' + encodeURIComponent(arena);
        if (selection && selection !== 'combined') url = `/api/stats?game=${encodeURIComponent(selection)}&arena=${encodeURIComponent(arena)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('network');
        const data = await res.json();
        currentList = data || [];
        renderRows(currentList, arena);

        // winner box: for game-specific, ask server for winner from games cache
        if (selection && selection !== 'combined') {
          const gmeta = gamesCache.find(x => x.id === selection);
          if (gmeta && gmeta.winner) {
            showWinnerBox(String(gmeta.winner).split('/').pop(), 'Winner (game)');
          } else if (currentList.length > 0) {
            showWinnerBox(currentList[0].player, 'Top player');
          } else showWinnerBox(null);
        } else {
          // combined: show top player if available
          if (currentList.length > 0) showWinnerBox(currentList[0].player, 'Top player (combined)');
          else showWinnerBox(null);
        }
      } catch (e) {
        console.error(e);
        rowsEl.innerHTML = '<div class="row"><div class="muted" style="grid-column:1/-1;padding:12px">Failed to load leaderboard</div></div>';
      }
    }

    function renderRows(data) {
      // default to normal if arena not provided
      const arena = arguments.length > 1 ? arguments[1] : (arenaSelect && arenaSelect.value) || 'normal';
      const q = (searchInput.value || '').toLowerCase().trim();
      const filtered = data.filter(r => !q || (String(r.player||'').toLowerCase().includes(q)));
      if (!filtered || filtered.length === 0) {
        rowsEl.innerHTML = '<div class="row"><div class="muted" style="grid-column:1/-1;padding:12px">No data yet.</div></div>';
        return;
      }
      if (arena === 'boss') {
        // boss mode: show hits-only
        rowsEl.innerHTML = filtered.map((r, i) => {
          const raw = String(r.player || '');
          const player = raw.replace(/^https?:\/\/[^\/]+\//, '').replace(/^\/+/, '').split('/').pop() || raw;
          const hits = r.hits || 0;
          return `<div class="row"><div style="width:48px">${i+1}</div><div class="player" title="${r.player}">${player}</div><div style="grid-column:3/-1;text-align:right">Hits: ${hits}</div></div>`;
        }).join('');
      } else {
        rowsEl.innerHTML = filtered.map((r, i) => {
          const raw = String(r.player || '');
          const player = raw.replace(/^https?:\/\/[^\/]+\//, '').replace(/^\/+/, '').split('/').pop() || raw;
          const kills = r.kills || 0;
          const hits = r.hits || 0;
          const wins = r.wins || 0;
          return `<div class="row"><div style="width:48px">${i+1}</div><div class="player" title="${r.player}">${player}</div><div style="text-align:right">${kills}</div><div style="text-align:right">${hits}</div><div style="text-align:right">${wins}</div></div>`;
        }).join('');
      }
    }

    refreshBtn.addEventListener('click', () => fetchStatsFor(gameSelect.value || 'combined'));
    gameSelect.addEventListener('change', () => fetchStatsFor(gameSelect.value || 'combined'));
    searchInput.addEventListener('input', () => renderRows(currentList));

    // subtle 3D tilt interaction for admin page
    (function(){
      const hero = document.querySelector('.hero') || document.body;
      const card = document.querySelector('.tilt-card') || document.querySelector('.card');
      if(!hero || !card) return;
      hero.addEventListener('pointermove', (e)=>{
        const rect = hero.getBoundingClientRect();
        const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
        const dx = e.clientX - cx; const dy = e.clientY - cy; const rx = -(dy/rect.height)*6; const ry = (dx/rect.width)*8;
        card.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) translateZ(8px)`;
      });
      hero.addEventListener('pointerleave', ()=>{ if(card) card.style.transform='none'; });
    })();

    resetBtn.addEventListener('click', async () => {
      if (!confirm('Reset leaderboard (clears all games and totals)?')) return;
      try {
        const arena = (arenaSelect.value || 'normal');
        const res = await fetch('/api/stats?arena=' + encodeURIComponent(arena), { method: 'DELETE' });
        if (!res.ok) throw new Error('Reset failed');
        await fetchGames();
        fetchStatsFor('combined');
      } catch (e) {
        alert('Reset failed');
      }
    });

    // export CSV removed per UI request

    // initial load: fetch games and stats once; further refreshes happen only on user action
    arenaSelect.addEventListener('change', async () => {
      const hdr = document.querySelector('.row.header');
      const arena = (arenaSelect.value || 'normal');
      if (hdr) {
        if (arena === 'boss') {
          hdr.innerHTML = '<div style="width:48px">#</div><div>Player</div><div style="grid-column:3/-1;text-align:right">Hits</div>';
        } else {
          hdr.innerHTML = '<div style="width:48px">#</div><div>Player</div><div style="text-align:right">Kills</div><div style="text-align:right">Hits</div><div style="text-align:right">Wins</div>';
        }
      }
      await fetchGames();
      fetchStatsFor(gameSelect.value || 'combined');
    });

    (async () => {
      await fetchGames();
      // initial stats load: respect current selection (default combined)
      fetchStatsFor(gameSelect.value || 'combined');
    })();
  </script>
</body>
</html>
